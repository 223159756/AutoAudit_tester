groups:
- name: container-health
  rules:
    # Service is unreachable (down) for over 5 minutes
    - alert: ServiceDown
      expr: up == 0
      for: 5m
      labels:
        severity: critical
        team: devops
      annotations:
        summary: "Service is unreachable"
        description: |
          The monitored service/job has been DOWN (no healthy targets) for over 5 minutes.

    # High average CPU usage for more than 10 minutes
    - alert: HighCPUUsage
      expr: avg by(instance)(rate(container_cpu_usage_seconds_total[5m])) > 0.9
      for: 10m
      labels:
        severity: warning
        team: devops
      annotations:
        summary: "High CPU usage"
        description: |
          Average CPU usage is above 90% for 10 minutes on {{ $labels.instance }}.

    # High average memory usage for more than 10 minutes
    - alert: HighMemoryUsage
      expr: avg by(instance)((container_memory_usage_bytes / container_spec_memory_limit_bytes) > 0.8) == 1
      for: 10m
      labels:
        severity: warning
        team: devops
      annotations:
        summary: "High Memory usage"
        description: |
          Average memory usage is above 80% for 10 minutes on {{ $labels.instance }}.
        - alert: HighErrorRate
      expr: sum(rate(http_requests_total{status=~"5.."}[5m])) by (job) / sum(rate(http_requests_total[5m])) by (job) > 0.02
      for: 5m
      labels: {severity: critical, team: devops}
      annotations:
        summary: "High error rate"
        description: "HTTP 5xx errors > 2% for 5 minutes on {{ $labels.job }}"

    - alert: SlowRequests
      expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, job)) > 2
      for: 5m
      labels: {severity: warning, team: devops}
      annotations:
        summary: "Slow response time"
        description: "95th percentile response time over 2 seconds for {{ $labels.job }}"

    - alert: DiskSpaceLow
      expr: node_filesystem_avail_bytes / node_filesystem_size_bytes < 0.1
      for: 10m
      labels: {severity: critical, team: devops}
      annotations:
        summary: "Disk space low"
        description: "Less than 10% disk space remaining on {{ $labels.instance }}"